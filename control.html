<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Scoreboard Control</title>
<style>
  body {
    background-color: #111;
    color: #fff;
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  /* Top scoreboard */
  .scoreboard {
    width: 95%;
    background: #1e1e1e;
    border-radius: 12px;
    padding: 10px;
    margin-bottom: 12px;
    text-align: center;
  }
  .team-row {
    display: flex;
    justify-content: space-between;
    font-weight: bold;
    font-size: 18px;
  }
  .score-row {
    display: flex;
    justify-content: space-between;
    font-size: 36px;
    margin-top: 6px;
  }
  .shots-row {
    display: flex;
    justify-content: space-between;
    font-size: 16px;
    margin-top: 4px;
    opacity: 0.85;
  }

  /* Clock + Period */
  .clock-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 95%;
    background: #1d1d1d;
    border-radius: 12px;
    padding: 10px;
    margin-bottom: 12px;
  }
  .clock-section button {
    flex: 1;
    font-size: 18px;
    padding: 14px 0;
    margin: 0 4px;
    border-radius: 8px;
    border: none;
    background-color: #333;
    color: #fff;
    cursor: pointer;
  }
  #timer { font-size: 28px; font-weight: bold; text-align: center; }
  #period { font-size: 18px; text-align: center; margin-top: 2px; }

  /* Start/Stop */
  #startStopBtn {
    width: 95%;
    font-size: 28px;
    padding: 40px 0;
    border-radius: 12px;
    border: none;
    color: white;
    background-color: #28a745;
    margin-bottom: 16px;
  }

  /* Team controls */
  .team-controls {
    display: flex;
    justify-content: space-between;
    width: 95%;
    gap: 10px;
  }
  .team-column {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .team-column button.plus {
    width: 100%;
    font-size: 24px;
    padding: 40px 0;
    border-radius: 10px;
    border: none;
    background-color: #555;
    color: #fff;
  }
  .team-column button.minus {
    width: 100%;
    font-size: 24px;
    padding: 12px 0;
    border-radius: 10px;
    border: none;
    background-color: #777;
    color: #fff;
  }

  /* Settings icon */
  .settings-btn {
    position: fixed;
    top: 10px;
    right: 10px;
    background: none;
    border: none;
    color: #fff;
    font-size: 28px;
    cursor: pointer;
  }

  /* Modal styling (keeps the same dark aesthetic) */
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); justify-content:center; align-items:center; }
  .modal-content { background:#222; padding:20px; border-radius:12px; width:90%; max-width:760px; }
  .modal-row { display:flex; gap:20px; }
  .modal-col { flex:1; display:flex; flex-direction:column; gap:10px; }
  select, input[type="text"] { padding:8px; border-radius:6px; border:none; font-size:16px; width:100%; }
  .modal-actions { display:flex; justify-content:space-between; margin-top:14px; }
  .btn { padding:10px 16px; border-radius:8px; border:none; cursor:pointer; font-size:16px; }
  .btn-update { background:#28a745; color:#fff; }
  .btn-cancel { background:#555; color:#fff; }
</style>
</head>
<body>
<button class="settings-btn" onclick="openSettings()">⚙️</button>

<!-- Top scoreboard -->
<div class="scoreboard">
  <div class="team-row">
    <span id="teamAName">SPKAC Leafs</span>
    <span id="teamBName">CAC Imperial</span>
  </div>
  <div class="score-row">
    <span id="teamAScore">0</span>
    <span style="opacity:0.8">-</span>
    <span id="teamBScore">0</span>
  </div>
  <div class="shots-row">
    <span id="teamAShots">Shots: 0</span>
    <span id="teamBShots">Shots: 0</span>
  </div>
</div>

<!-- Clock + Period -->
<div class="clock-section">
  <button onclick="setPeriod()">Period</button>
  <div style="flex:2;">
    <div id="timer">20:00</div>
    <div id="period">Period 1</div>
  </div>
  <button onclick="setClock()">Clock</button>
</div>

<!-- Start/Stop -->
<button id="startStopBtn" onclick="toggleClock()">Start</button>

<!-- Team Controls -->
<div class="team-controls">
  <div class="team-column">
    <button class="plus" onclick="updateShots('A',1)">+1 Shot</button>
    <button class="minus" onclick="updateShots('A',-1)">-1 Shot</button>
    <button class="plus" onclick="updateScore('A',1)">+1 Goal</button>
    <button class="minus" onclick="updateScore('A',-1)">-1 Goal</button>
  </div>
  <div class="team-column">
    <button class="plus" onclick="updateShots('B',1)">+1 Shot</button>
    <button class="minus" onclick="updateShots('B',-1)">-1 Shot</button>
    <button class="plus" onclick="updateScore('B',1)">+1 Goal</button>
    <button class="minus" onclick="updateScore('B',-1)">-1 Goal</button>
  </div>
</div>

<!-- Modal -->
<div id="settingsModal" class="modal">
  <div class="modal-content">
    <h3 style="margin-top:0">Team Setup</h3>
    <div class="modal-row">
      <div class="modal-col">
        <strong>Team A</strong>
        <select id="teamADropdown" onchange="onDropdownChange('A')"></select>
        <input id="teamACustom" type="text" placeholder="Enter custom team name" style="display:none;">
      </div>
      <div class="modal-col">
        <strong>Team B</strong>
        <select id="teamBDropdown" onchange="onDropdownChange('B')"></select>
        <input id="teamBCustom" type="text" placeholder="Enter custom team name" style="display:none;">
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn btn-update" onclick="confirmUpdateTeams()">Update</button>
      <button class="btn btn-cancel" onclick="closeSettings()">Cancel</button>
    </div>
  </div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzch9SYxZbzoGwZm3rlgzDPmZes1mjFD0GWJrzTzuF-ndvH51lLW7HGTOZXfh0NdY_K/exec"; // <- REPLACE with /exec URL

let state = {
  teamAName: '',
  teamBName: '',
  teamAScore: 0,
  teamBScore: 0,
  teamAShots: 0,
  teamBShots: 0,
  Period: 1,
  TimerSeconds: 1200,
  Running: false
};
let timerInterval = null;
let timerSyncInterval = null; // for 5s pushes

// ---------- Initialization ----------
async function init(){
  try {
    const r = await fetch(SCRIPT_URL);
    const data = await r.json();
    // merge into state (with defaults)
    state = Object.assign(state, data);
    // ensure numbers
    ['teamAScore','teamBScore','teamAShots','teamBShots','Period','TimerSeconds'].forEach(k=>{
      state[k] = Number(state[k]) || 0;
    });
    state.Running = !!state.Running;
    updateUI();
    await loadTeamList(); // populate dropdowns
    if(state.Running) startTimer();
  } catch(err){
    console.error('init error', err);
  }
}

function updateUI(){
  document.getElementById('teamAName').textContent = state.teamAName || '';
  document.getElementById('teamBName').textContent = state.teamBName || '';
  document.getElementById('teamAScore').textContent = state.teamAScore;
  document.getElementById('teamBScore').textContent = state.teamBScore;
  document.getElementById('teamAShots').textContent = `Shots: ${state.teamAShots}`;
  document.getElementById('teamBShots').textContent = `Shots: ${state.teamBShots}`;
  document.getElementById('timer').textContent = formatTime(state.TimerSeconds);
  document.getElementById('period').textContent = `Period ${state.Period}`;
  const btn = document.getElementById('startStopBtn');
  btn.textContent = state.Running ? 'Stop' : 'Start';
  btn.style.backgroundColor = state.Running ? '#dc3545' : '#28a745';
}

function formatTime(sec){
  const m = Math.floor(sec/60);
  const s = sec % 60;
  return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

// ---------- Timer ----------
function startTimer(){
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(()=>{
    if(state.TimerSeconds>0 && state.Running){
      state.TimerSeconds--;
      document.getElementById('timer').textContent = formatTime(state.TimerSeconds);
    }
  },1000);

  // sync (push) the TimerSeconds every 5s
  if(timerSyncInterval) clearInterval(timerSyncInterval);
  timerSyncInterval = setInterval(()=> {
    pushUpdate('TimerSeconds', state.TimerSeconds);
  }, 5000);
}

function stopTimer(){
  if(timerInterval) clearInterval(timerInterval);
  if(timerSyncInterval) clearInterval(timerSyncInterval);
  timerInterval = null;
  timerSyncInterval = null;
}

// ---------- Controls ----------
function toggleClock(){
  state.Running = !state.Running;
  updateUI();
  pushUpdate('Running', state.Running);
  if(state.Running) startTimer(); else stopTimer();
}

function setClock(){
  const raw = prompt('Enter time (MM:SS)');
  if(!raw) return;
  if(!/^\d{1,2}:\d{2}$/.test(raw)){ alert('Invalid format'); return; }
  const [m,s] = raw.split(':').map(Number);
  state.TimerSeconds = m*60 + s;
  updateUI();
  pushUpdate('TimerSeconds', state.TimerSeconds);
}

function setPeriod(){
  const raw = prompt('Enter period number');
  const n = parseInt(raw);
  if(isNaN(n) || n<1) return;
  state.Period = n;
  updateUI();
  pushUpdate('Period', n);
}

function updateScore(team, change){
  const key = team==='A' ? 'teamAScore' : 'teamBScore';
  state[key] = Math.max(0, (state[key]||0) + change);
  updateUI();
  pushUpdate(key, state[key]);
}

function updateShots(team, change){
  const key = team==='A' ? 'teamAShots' : 'teamBShots';
  state[key] = Math.max(0, (state[key]||0) + change);
  updateUI();
  pushUpdate(key, state[key]);
}

// ---------- Push update to Apps Script ----------
async function pushUpdate(field, value){
  try {
    const url = `${SCRIPT_URL}?update=true&field=${encodeURIComponent(field)}&value=${encodeURIComponent(value)}`;
    const res = await fetch(url);
    // optional: check JSON result
    // const j = await res.json();
    // console.log('push result', j);
  } catch(err){
    console.error('pushUpdate error', err);
  }
}

// ---------- Modal / Team list ----------
async function loadTeamList(){
  try {
    const res = await fetch(`${SCRIPT_URL}?list=true`);
    const list = await res.json();
    const ddA = document.getElementById('teamADropdown');
    const ddB = document.getElementById('teamBDropdown');
    // clear and add -- Custom --
    [ddA, ddB].forEach(dd => {
      dd.innerHTML = '';
      const custom = document.createElement('option');
      custom.value = '-- Custom --';
      custom.textContent = '-- Custom --';
      dd.appendChild(custom);
      list.forEach(name=>{
        const o = document.createElement('option');
        o.value = name;
        o.textContent = name;
        dd.appendChild(o);
      });
      // set initial selection to current team if present
      if(dd === ddA) dd.value = state.teamAName || '-- Custom --';
      if(dd === ddB) dd.value = state.teamBName || '-- Custom --';
    });
    // ensure custom inputs visible when needed
    onDropdownChange('A');
    onDropdownChange('B');
  } catch(err){
    console.error('loadTeamList error', err);
  }
}

function openSettings(){
  document.getElementById('settingsModal').style.display = 'flex';
}

function closeSettings(){
  document.getElementById('settingsModal').style.display = 'none';
}

function onDropdownChange(team){
  const dd = document.getElementById(`team${team}Dropdown`);
  const input = document.getElementById(`team${team}Custom`);
  if(dd.value === '-- Custom --'){ input.style.display = 'block'; input.value = ''; }
  else { input.style.display = 'none'; input.value = ''; }
}

function confirmUpdateTeams(){
  // Validate both sides
  const sides = ['A','B'];
  for(const t of sides){
    const dd = document.getElementById(`team${t}Dropdown`);
    const input = document.getElementById(`team${t}Custom`);
    let name;
    if(dd.value === '-- Custom --'){
      name = input.value.trim();
      if(!name){ alert('Enter custom team value'); return; }
    } else name = dd.value;
    // update local and push
    const field = (t==='A') ? 'teamAName' : 'teamBName';
    state[field] = name;
    pushUpdate(field, name);
  }
  updateUI();
  closeSettings();
}

window.onload = init;
</script>
</body>
</html>
