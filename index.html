<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Scoreboard Overlay</title>
<style>
  body {
    margin: 0;
    background-color: transparent;
    font-family: Arial, sans-serif;
    color: white;
  }

  .scoreboard {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 40px;
    background-color: rgba(0,0,0,0.5);
    border-radius: 12px;
  }

  .team {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .team img {
    height: 50px;
  }

  .team-name {
    font-size: 24px;
    font-weight: bold;
  }

  .score {
    font-size: 64px;
    font-weight: bold;
  }

  .shots {
    font-size: 16px;
    opacity: 0.8;
  }

  .center {
    text-align: center;
  }

  .clock {
    font-size: 40px;
    font-weight: bold;
    margin-bottom: 4px;
  }

  .period {
    font-size: 20px;
  }
</style>
</head>
<body>

<div class="scoreboard">
  <!-- Team A -->
  <div class="team" id="teamASection">
    <img id="teamALogo" src="" alt="Team A Logo" />
    <div>
      <div id="teamAName" class="team-name">Team A</div>
      <div id="teamAShots" class="shots">Shots: 0</div>
    </div>
  </div>

  <!-- Center Clock -->
  <div class="center">
    <div id="clock" class="clock">20:00</div>
    <div id="period" class="period">Period 1</div>
  </div>

  <!-- Team B -->
  <div class="team" id="teamBSection">
    <div style="text-align: right;">
      <div id="teamBName" class="team-name">Team B</div>
      <div id="teamBShots" class="shots">Shots: 0</div>
    </div>
    <img id="teamBLogo" src="" alt="Team B Logo" />
  </div>
</div>

<script>
const DATA_URL = "https://script.google.com/macros/s/AKfycbwaUrSiXOROipgs8G_OjsxyNa8g78hTvDTGygqMo-1fP22yBTi323F-Ji7Wu9k_Us12/exec";

let timeRemaining = 20 * 60;
let lastRunning = false;
let isRunning = false;
let lastTimerSeconds = timeRemaining;
let period = 1;
let timerInterval = null;

function formatTime(sec) {
  const m = Math.floor(sec / 60);
  const s = sec % 60;
  return `${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
}

function updateDisplay(data) {
  document.getElementById("teamAName").textContent = data.teamAName || "Team A";
  document.getElementById("teamBName").textContent = data.teamBName || "Team B";
  document.getElementById("teamAShots").textContent = `Shots: ${data.teamAShots || 0}`;
  document.getElementById("teamBShots").textContent = `Shots: ${data.teamBShots || 0}`;
  document.getElementById("teamALogo").src = data.teamALogo || "";
  document.getElementById("teamBLogo").src = data.teamBLogo || "";
  document.getElementById("teamASection").style.color = data.teamAColor || "#fff";
  document.getElementById("teamBSection").style.color = data.teamBColor || "#fff";

  document.getElementById("clock").textContent = formatTime(timeRemaining);
  document.getElementById("period").textContent = `Period ${data.Period || 1}`;
}

function startLocalTimer() {
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    if (isRunning && timeRemaining > 0) {
      timeRemaining--;
      document.getElementById("clock").textContent = formatTime(timeRemaining);
    }
  }, 1000);
}

async function fetchData() {
  try {
    const res = await fetch(DATA_URL);
    const data = await res.json();

    // Update static data
    period = parseInt(data.Period || 1);
    document.getElementById("period").textContent = `Period ${period}`;
    updateDisplay(data);

    // Handle timer + running logic
    const sheetRunning = data.Running === true || data.Running === "true";
    const sheetSeconds = parseInt(data.TimerSeconds || 1200);

    // Only react when Running or TimerSeconds change
    if (sheetRunning !== lastRunning || sheetSeconds !== lastTimerSeconds) {
      console.log("Detected change in timer state:", { sheetRunning, sheetSeconds });
      isRunning = sheetRunning;
      lastRunning = sheetRunning;
      lastTimerSeconds = sheetSeconds;
      timeRemaining = sheetSeconds;
    }

    startLocalTimer();
  } catch (err) {
    console.error("Fetch error:", err);
  }
}

fetchData();
setInterval(fetchData, 2000);
</script>
</body>
</html>
